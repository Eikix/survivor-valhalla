name: Deploy to Mainnet

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Nix
      uses: cachix/install-nix-action@v22
      with:
        nix_path: nixpkgs=channel:nixos-unstable
    
    - name: Build contracts
      working-directory: ./contract
      run: |
        nix develop ..#default --command sozo -P mainnet build
    
    - name: Deploy contracts
      working-directory: ./contract
      env:
        STARKNET_RPC_URL: ${{ secrets.STARKNET_RPC_URL_MAINNET }}
        DOJO_ACCOUNT_ADDRESS: ${{ secrets.DOJO_ACCOUNT_ADDRESS }}
        DOJO_PRIVATE_KEY: ${{ secrets.DOJO_PRIVATE_KEY }}
      run: |
        nix develop ..#default --command sozo -P mainnet migrate
        
    - name: Extract World Address
      working-directory: ./contract
      id: world
      run: |
        WORLD_ADDRESS=$(grep "world_address" dojo_mainnet.toml | cut -d '"' -f 2)
        echo "world_address=$WORLD_ADDRESS" >> $GITHUB_OUTPUT
        echo "World Address: $WORLD_ADDRESS"
    
    - name: Authenticate Slot
      env:
        SLOT_AUTH_TOKEN: ${{ secrets.SLOT_AUTH_TOKEN }}
      run: |
        echo "$SLOT_AUTH_TOKEN" | nix develop --command slot auth login --token
    
    - name: Deploy Torii
      env:
        STARKNET_RPC_URL: https://api.cartridge.gg/x/starknet/mainnet
      run: |
        # Delete existing deployment if it exists
        nix develop --command slot deployments delete survivor-valhalla torii || true
        
        # Create new Torii deployment
        nix develop --command slot deployments create survivor-valhalla torii \
          --version v1.7.1 \
          --world ${{ steps.world.outputs.world_address }} \
          --rpc $STARKNET_RPC_URL
        
        # Save deployment info
        nix develop --command slot deployments list survivor-valhalla > deployment-info.txt
        cat deployment-info.txt
    
    - name: Upload deployment info
      uses: actions/upload-artifact@v4
      with:
        name: deployment-info
        path: deployment-info.txt
    
    - name: Verify contracts with Walnut
      working-directory: ./contract
      continue-on-error: true
      run: |
        nix develop ..#default --command sozo walnut verify || echo "Walnut verification started - check the provided link"

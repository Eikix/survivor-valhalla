name: Deploy to Mainnet

on:
  push:
    branches:
      - main
    paths:
      - 'contract/**'
      - '.github/workflows/deploy-mainnet.yml'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Build contracts
      working-directory: ./contract
      run: |
        docker run --rm \
          --platform linux/arm64 \
          -v ${{ github.workspace }}/contract:/app \
          -w /app \
          ghcr.io/dojoengine/dojo:v1.7.1 \
          sozo -P mainnet build
    
    - name: Check and set environment
      id: env
      run: |
        # Use secret or default RPC URL
        if [ -z "${{ secrets.STARKNET_RPC_URL_MAINNET }}" ]; then
          echo "Warning: STARKNET_RPC_URL_MAINNET secret not set, using default"
          echo "rpc_url=https://api.cartridge.gg/x/starknet/mainnet" >> $GITHUB_OUTPUT
        else
          echo "rpc_url=${{ secrets.STARKNET_RPC_URL_MAINNET }}" >> $GITHUB_OUTPUT
        fi
        
        # Check required secrets
        if [ -z "${{ vars.DOJO_ACCOUNT_ADDRESS }}" ]; then
          echo "Error: DOJO_ACCOUNT_ADDRESS variable is not set"
          echo "Please set the following in your repository:"
          echo "- Variable: DOJO_ACCOUNT_ADDRESS - Your Starknet account address"
          echo "- Secret: DOJO_PRIVATE_KEY - Your account private key"
          echo "- Secret: STARKNET_RPC_URL_MAINNET - (Optional) Custom RPC URL"
          exit 1
        fi
        if [ -z "${{ secrets.DOJO_PRIVATE_KEY }}" ]; then
          echo "Error: DOJO_PRIVATE_KEY secret is not set"
          exit 1
        fi
        echo "All required configuration is set"
    
    - name: Deploy contracts
      working-directory: ./contract
      env:
        STARKNET_RPC_URL: ${{ steps.env.outputs.rpc_url }}
        DOJO_ACCOUNT_ADDRESS: ${{ vars.DOJO_ACCOUNT_ADDRESS }}
        DOJO_PRIVATE_KEY: ${{ secrets.DOJO_PRIVATE_KEY }}
      run: |
        docker run --rm \
          --platform linux/arm64 \
          -v ${{ github.workspace }}/contract:/app \
          -w /app \
          -e STARKNET_RPC_URL=$STARKNET_RPC_URL \
          -e DOJO_ACCOUNT_ADDRESS=$DOJO_ACCOUNT_ADDRESS \
          -e DOJO_PRIVATE_KEY=$DOJO_PRIVATE_KEY \
          ghcr.io/dojoengine/dojo:v1.7.1 \
          sozo -P mainnet migrate
        
    - name: Extract World Address
      working-directory: ./contract
      id: world
      run: |
        WORLD_ADDRESS=$(grep "world_address" dojo_mainnet.toml | cut -d '"' -f 2)
        echo "world_address=$WORLD_ADDRESS" >> $GITHUB_OUTPUT
        echo "World Address: $WORLD_ADDRESS"
    
    - name: Deploy Torii with Slot
      env:
        SLOT_AUTH_TOKEN: ${{ secrets.SLOT_AUTH_TOKEN }}
        STARKNET_RPC_URL: https://api.cartridge.gg/x/starknet/mainnet
      run: |
        docker run --rm \
          --platform linux/arm64 \
          -v ${{ github.workspace }}/contract:/app \
          -w /app \
          -e SLOT_AUTH_TOKEN=$SLOT_AUTH_TOKEN \
          -e STARKNET_RPC_URL=$STARKNET_RPC_URL \
          ghcr.io/dojoengine/dojo:v1.7.1 bash -c "
            echo \"\$SLOT_AUTH_TOKEN\" | slot auth login --token
            slot deployments delete survivor-valhalla torii || true
            slot deployments create survivor-valhalla torii \
              --version v1.7.1 \
              --world ${{ steps.world.outputs.world_address }} \
              --rpc \$STARKNET_RPC_URL
            slot deployments list survivor-valhalla
          " > deployment-info.txt
        cat deployment-info.txt
    
    - name: Upload deployment info
      uses: actions/upload-artifact@v4
      with:
        name: deployment-info
        path: deployment-info.txt
    
    - name: Verify contracts with Walnut
      working-directory: ./contract
      continue-on-error: true
      run: |
        docker run --rm \
          --platform linux/arm64 \
          -v ${{ github.workspace }}/contract:/app \
          -w /app \
          ghcr.io/dojoengine/dojo:v1.7.1 \
          sozo walnut verify || echo "Walnut verification started - check the provided link"